<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tower Defense Game</title>
    <style>
        body {
            font-family: 'Arial', sans-serif;
            display: flex;
            flex-direction: column;
            align-items: center;
            background-color: #2c3e50;
            margin: 0;
            padding: 20px;
            color: #ecf0f1;
        }
        
        h1 {
            color: #f1c40f;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.5);
            margin-bottom: 20px;
        }
        
        .game-container {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        #gameCanvas {
            background-color: #27ae60; /* Зеленый цвет поля */
            border: 3px solid #f1c40f;
            border-radius: 8px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        
        .shop {
            background-color: #34495e;
            border: 3px solid #f1c40f;
            border-radius: 8px;
            padding: 15px;
            width: 250px;
            box-shadow: 0 0 15px rgba(0, 0, 0, 0.5);
        }
        
        .shop h2 {
            margin-top: 0;
            text-align: center;
            color: #f1c40f;
            border-bottom: 2px solid #f1c40f;
            padding-bottom: 10px;
        }
        
        .tower-item {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
            padding: 10px;
            border: 1px solid #555;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.2s;
            background-color: #2c3e50;
        }
        
        .tower-item:hover {
            background-color: #3d566e;
            transform: translateY(-2px);
        }
        
        .tower-preview {
            width: 24px;
            height: 24px;
            margin-right: 10px;
            border: 1px solid #777;
        }
        
        .tower-info {
            flex-grow: 1;
        }
        
        .tower-name {
            font-weight: bold;
            color: #f1c40f;
        }
        
        .tower-stats {
            font-size: 0.8em;
            color: #bdc3c7;
        }
        
        .tower-price {
            font-weight: bold;
            color: #2ecc71;
            background-color: rgba(0, 0, 0, 0.3);
            padding: 3px 6px;
            border-radius: 4px;
        }
        
        .info-panel {
            display: flex;
            justify-content: space-between;
            width: 800px;
            margin-bottom: 15px;
            background-color: #34495e;
            padding: 10px 20px;
            border-radius: 8px;
            border: 2px solid #f1c40f;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.3);
        }
        
        .stats {
            font-weight: bold;
            display: flex;
            gap: 20px;
        }
        
        .stats span {
            color: #f1c40f;
        }
        
        .controls {
            display: flex;
            gap: 10px;
        }
        
        button {
            padding: 8px 15px;
            background-color: #e74c3c;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
            transition: background-color 0.2s;
        }
        
        button:hover {
            background-color: #c0392b;
        }
        
        #toggleRadius {
            background-color: #3498db;
        }
        
        #toggleRadius:hover {
            background-color: #2980b9;
        }
        
        #restartGame {
            display: none;
            background-color: #e74c3c;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            padding: 15px 30px;
            font-size: 1.2em;
            z-index: 100;
        }
        
        .game-overlay {
            display: none;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.8);
            z-index: 99;
        }
        
        .upgrade-option {
            margin-top: 5px;
            padding-top: 5px;
            border-top: 1px dashed #555;
            font-size: 0.8em;
            color: #e67e22;
        }
        
        .selected {
            box-shadow: 0 0 10px #f1c40f;
            border-color: #f1c40f;
        }
    </style>
</head>
<body>
    <h1>Tower Defense</h1>
    
    <div class="info-panel">
        <div class="stats">
            Деньги: <span id="money">100</span> | 
            Жизни: <span id="lives">20</span> | 
            Волна: <span id="wave">0</span>
        </div>
        <div class="controls">
            <button id="toggleRadius">Скрыть радиус</button>
        </div>
    </div>
    
    <div class="game-container">
        <canvas id="gameCanvas" width="600" height="400"></canvas>
        
        <div class="shop">
            <h2>Магазин</h2>
            <div class="tower-item" data-type="pistol" data-price="50">
                <div class="tower-preview" style="background-color: blue; border-radius: 50%;"></div>
                <div class="tower-info">
                    <div class="tower-name">Пистолет</div>
                    <div class="tower-stats">Урон: 1/сек | Радиус: 10st</div>
                    <div class="upgrade-option">Улучшение: 150 монет → 2 урона/сек, радиус 12st</div>
                </div>
                <div class="tower-price">50</div>
            </div>
            
            <div class="tower-item" data-type="swordsman" data-price="125">
                <div class="tower-preview" style="background-color: red; transform: rotate(45deg);"></div>
                <div class="tower-info">
                    <div class="tower-name">Мечник</div>
                    <div class="tower-stats">Урон: 1/0.5сек | Радиус: 4st</div>
                    <div class="upgrade-option">Улучшение: 300 монет → 2 урона/0.5сек</div>
                </div>
                <div class="tower-price">125</div>
            </div>
            
            <div class="tower-item" data-type="sniper" data-price="250">
                <div class="tower-preview" style="background-color: purple;"></div>
                <div class="tower-info">
                    <div class="tower-name">Снайпер</div>
                    <div class="tower-stats">Урон: 10/5сек | Радиус: 100st</div>
                    <div class="upgrade-option">Улучшение: 1000 монет → 25 урона/2.5сек</div>
                </div>
                <div class="tower-price">250</div>
            </div>
        </div>
    </div>
    
    <button id="restartGame">Начать заново</button>
    <div class="game-overlay" id="gameOverlay"></div>
    
    <script>
        // Получаем элементы canvas и контекст
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        
        // Игровые переменные
        let money = 100;
        let lives = 20;
        let wave = 0;
        let enemies = [];
        let towers = [];
        let bullets = [];
        let selectedTowerType = null;
        let selectedTower = null;
        let gameActive = true;
        let enemySpawnTimer = 0;
        let enemiesToSpawn = 0;
        let showRadius = true;
        let waveActive = false;
        let redCount = 0;
        let purpleCount = 0;
        let goldenCount = 0;
        
        // Константы
        const ENEMY_BASE_SPEED = 1;
        const ENEMY_SIZE = 10;
        const TOWER_SIZE = 15;
        const BULLET_SIZE = 5;
        
        // Путь для врагов (желтая тропинка)
        const PATH = [
            {x: -20, y: 200},
            {x: 100, y: 200},
            {x: 100, y: 100},
            {x: 300, y: 100},
            {x: 300, y: 300},
            {x: 500, y: 300},
            {x: 500, y: 200},
            {x: 620, y: 200}
        ];
        
        // Класс врага
        class Enemy {
            constructor(type, health, speed, size, color) {
                this.type = type;
                this.health = health;
                this.maxHealth = health;
                this.speed = speed;
                this.size = size;
                this.color = color;
                this.x = PATH[0].x;
                this.y = PATH[0].y;
                this.pathIndex = 0;
            }
            
            update() {
                // Движение по пути
                const targetX = PATH[this.pathIndex].x;
                const targetY = PATH[this.pathIndex].y;
                
                const dx = targetX - this.x;
                const dy = targetY - this.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < this.speed) {
                    this.x = targetX;
                    this.y = targetY;
                    this.pathIndex++;
                    
                    // Если враг дошел до конца пути
                    if (this.pathIndex >= PATH.length) {
                        lives--;
                        updateStats();
                        
                        // Проверка на проигрыш
                        if (lives <= 0) {
                            gameOver();
                        }
                        
                        return false;
                    }
                } else {
                    this.x += (dx / distance) * this.speed;
                    this.y += (dy / distance) * this.speed;
                }
                
                return true;
            }
            
            draw() {
                // Рисуем врага
                ctx.fillStyle = this.color;
                
                if (this.type === 'red') {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.type === 'purple') {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.type === 'golden') {
                    // Золотой враг с эффектом сияния
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    
                    // Градиент для золотого врага
                    const gradient = ctx.createRadialGradient(
                        this.x, this.y, 0, 
                        this.x, this.y, this.size
                    );
                    gradient.addColorStop(0, '#FFD700');
                    gradient.addColorStop(1, '#DAA520');
                    
                    ctx.fillStyle = gradient;
                    ctx.fill();
                    
                    // Эффект сияния
                    ctx.strokeStyle = 'rgba(255, 215, 0, 0.6)';
                    ctx.lineWidth = 2;
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size + 3, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Рисуем полоску здоровья
                const healthWidth = (this.health / this.maxHealth) * (this.size * 2);
                ctx.fillStyle = 'rgba(0, 0, 0, 0.5)';
                ctx.fillRect(this.x - this.size, this.y - this.size - 8, this.size * 2, 4);
                ctx.fillStyle = this.type === 'golden' ? '#00ff00' : 'red';
                ctx.fillRect(this.x - this.size, this.y - this.size - 8, healthWidth, 4);
            }
            
            takeDamage(damage) {
                this.health -= damage;
                if (this.health <= 0) {
                    money += this.type === 'red' ? 10 : this.type === 'purple' ? 25 : 50;
                    updateStats();
                    return true;
                }
                return false;
            }
        }
        
        // Класс башни
        class Tower {
            constructor(x, y, type) {
                this.x = x;
                this.y = y;
                this.type = type;
                this.upgraded = false;
                
                // Установка параметров в зависимости от типа
                switch(type) {
                    case 'pistol':
                        this.radius = 20; // 10st = 20px
                        this.damage = 1;
                        this.fireRate = 60; // 1 выстрел в секунду (60 FPS)
                        this.color = 'blue';
                        this.shape = 'circle';
                        this.upgradeCost = 150;
                        break;
                    case 'swordsman':
                        this.radius = 8; // 4st = 8px
                        this.damage = 1;
                        this.fireRate = 30; // 2 выстрела в секунду
                        this.color = 'red';
                        this.shape = 'diamond';
                        this.upgradeCost = 300;
                        break;
                    case 'sniper':
                        this.radius = 200; // 100st = 200px
                        this.damage = 10;
                        this.fireRate = 300; // 1 выстрел в 5 секунд
                        this.color = 'purple';
                        this.shape = 'square';
                        this.upgradeCost = 1000;
                        break;
                }
                
                this.cooldown = 0;
                this.size = TOWER_SIZE;
            }
            
            upgrade() {
                if (this.upgraded) return false;
                
                switch(this.type) {
                    case 'pistol':
                        this.damage = 2;
                        this.radius = 24; // +2st = 4px
                        this.upgraded = true;
                        return true;
                    case 'swordsman':
                        this.damage = 2;
                        this.upgraded = true;
                        return true;
                    case 'sniper':
                        this.damage = 25;
                        this.fireRate = 150; // 1 выстрел в 2.5 секунды
                        this.upgraded = true;
                        return true;
                }
                
                return false;
            }
            
            update() {
                // Поиск врага в радиусе
                let target = null;
                let minDist = this.radius;
                
                for (const enemy of enemies) {
                    const dx = enemy.x - this.x;
                    const dy = enemy.y - this.y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < minDist) {
                        minDist = distance;
                        target = enemy;
                    }
                }
                
                // Стрельба по врагу
                if (target && this.cooldown <= 0) {
                    bullets.push({
                        x: this.x,
                        y: this.y,
                        target: target,
                        damage: this.damage,
                        speed: 5,
                        size: BULLET_SIZE,
                        color: this.type === 'pistol' ? 'cyan' : 
                               this.type === 'swordsman' ? 'orange' : 'yellow'
                    });
                    this.cooldown = this.fireRate;
                }
                
                if (this.cooldown > 0) {
                    this.cooldown--;
                }
            }
            
            draw() {
                // Рисуем башню
                ctx.fillStyle = this.color;
                
                if (this.shape === 'circle') {
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.size, 0, Math.PI * 2);
                    ctx.fill();
                } else if (this.shape === 'diamond') {
                    ctx.save();
                    ctx.translate(this.x, this.y);
                    ctx.rotate(45 * Math.PI / 180);
                    ctx.fillRect(-this.size/2, -this.size/2, this.size, this.size);
                    ctx.restore();
                } else if (this.shape === 'square') {
                    ctx.fillRect(this.x - this.size/2, this.y - this.size/2, this.size, this.size);
                }
                
                // Рисуем радиус (только при выборе и если включено отображение)
                if ((selectedTower === this || selectedTowerType === this.type) && showRadius) {
                    ctx.strokeStyle = 'rgba(255, 255, 255, 0.5)';
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.arc(this.x, this.y, this.radius, 0, Math.PI * 2);
                    ctx.stroke();
                    ctx.setLineDash([]);
                    
                    // Показываем уровень улучшения
                    if (this.upgraded) {
                        ctx.fillStyle = 'gold';
                        ctx.font = '10px Arial';
                        ctx.fillText('Ул.', this.x - 7, this.y + 4);
                    }
                }
            }
        }
        
        // Функция обновления статистики
        function updateStats() {
            document.getElementById('money').textContent = money;
            document.getElementById('lives').textContent = lives;
            document.getElementById('wave').textContent = wave;
        }
        
        // Функция начала волны
        function startWave() {
            if (!gameActive || waveActive) return;
            
            wave++;
            waveActive = true;
            
            // Определяем количество и тип врагов в зависимости от волны
            redCount = 2 + wave * 2; // +2 красных с каждой волной
            purpleCount = 0;
            goldenCount = 0;
            
            // Добавляем фиолетовых врагов после 5 волны
            if (wave >= 5) {
                purpleCount = Math.floor((wave - 5) / 2) + 1;
            }
            
            // Добавляем золотых врагов после 25 волны
            if (wave >= 25) {
                goldenCount = Math.floor((wave - 25) / 2) + 1;
            }
            
            enemiesToSpawn = redCount + purpleCount + goldenCount;
            enemySpawnTimer = 30; // Задержка перед первым врагом
            
            updateStats();
        }
        
        // Функция спавна врагов
        function spawnEnemy() {
            if (enemiesToSpawn > 0 && enemySpawnTimer <= 0) {
                let enemy;
                
                if (goldenCount > 0) {
                    enemy = new Enemy('golden', 35, ENEMY_BASE_SPEED * 2, ENEMY_SIZE, 'gold');
                    goldenCount--;
                } else if (purpleCount > 0) {
                    enemy = new Enemy('purple', 15, ENEMY_BASE_SPEED * 0.5, ENEMY_SIZE, 'purple');
                    purpleCount--;
                } else {
                    enemy = new Enemy('red', 3 + Math.floor(wave / 3), ENEMY_BASE_SPEED, ENEMY_SIZE, 'red');
                    redCount--;
                }
                
                enemies.push(enemy);
                enemiesToSpawn--;
                enemySpawnTimer = 30; // Задержка между врагами
            }
            
            if (enemySpawnTimer > 0) {
                enemySpawnTimer--;
            }
            
            // Если все враги созданы и все убиты - начинаем следующую волну
            if (enemiesToSpawn === 0 && enemies.length === 0) {
                waveActive = false;
                // Автоматически начинаем следующую волну
                setTimeout(startWave, 2000);
            }
        }
        
        // Функция обновления пуль
        function updateBullets() {
            for (let i = bullets.length - 1; i >= 0; i--) {
                const bullet = bullets[i];
                
                // Если цель уже уничтожена, удаляем пулю
                if (!enemies.includes(bullet.target)) {
                    bullets.splice(i, 1);
                    continue;
                }
                
                // Движение пули к цели
                const dx = bullet.target.x - bullet.x;
                const dy = bullet.target.y - bullet.y;
                const distance = Math.sqrt(dx * dx + dy * dy);
                
                if (distance < bullet.speed) {
                    // Попадание по врагу
                    if (bullet.target.takeDamage(bullet.damage)) {
                        enemies.splice(enemies.indexOf(bullet.target), 1);
                    }
                    bullets.splice(i, 1);
                } else {
                    bullet.x += (dx / distance) * bullet.speed;
                    bullet.y += (dy / distance) * bullet.speed;
                }
            }
        }
        
        // Функция завершения игры
        function gameOver() {
            gameActive = false;
            document.getElementById('restartGame').style.display = 'block';
            document.getElementById('gameOverlay').style.display = 'block';
        }
        
        // Рисуем путь (желтая тропинка)
        function drawPath() {
            ctx.strokeStyle = '#f1c40f'; // Желтый цвет
            ctx.lineWidth = 30;
            ctx.lineJoin = 'round';
            ctx.lineCap = 'round';
            ctx.beginPath();
            ctx.moveTo(PATH[0].x, PATH[0].y);
            
            for (let i = 1; i < PATH.length; i++) {
                ctx.lineTo(PATH[i].x, PATH[i].y);
            }
            
            ctx.stroke();
            
            // Добавляем текстуру тропинки
            ctx.strokeStyle = '#d35400';
            ctx.lineWidth = 2;
            ctx.setLineDash([5, 15]);
            ctx.beginPath();
            ctx.moveTo(PATH[0].x, PATH[0].y);
            
            for (let i = 1; i < PATH.length; i++) {
                ctx.lineTo(PATH[i].x, PATH[i].y);
            }
            
            ctx.stroke();
            ctx.setLineDash([]);
        }
        
        // Основной игровой цикл
        function gameLoop() {
            if (!gameActive) return;
            
            // Очистка canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Рисуем путь
            drawPath();
            
            // Спавн врагов
            spawnEnemy();
            
            // Обновление врагов
            for (let i = enemies.length - 1; i >= 0; i--) {
                if (!enemies[i].update()) {
                    enemies.splice(i, 1);
                }
            }
            
            // Обновление башен
            for (const tower of towers) {
                tower.update();
                tower.draw();
            }
            
            // Обновление пуль
            updateBullets();
            
            // Рисуем пули
            for (const bullet of bullets) {
                ctx.fillStyle = bullet.color;
                ctx.beginPath();
                ctx.arc(bullet.x, bullet.y, bullet.size, 0, Math.PI * 2);
                ctx.fill();
            }
            
            // Рисуем врагов
            for (const enemy of enemies) {
                enemy.draw();
            }
            
            // Автозапуск первой волны
            if (wave === 0 && !waveActive) {
                startWave();
            }
            
            requestAnimationFrame(gameLoop);
        }
        
        // Обработчик клика по canvas
        canvas.addEventListener('click', (e) => {
            if (!gameActive) return;
            
            const rect = canvas.getBoundingClientRect();
            const x = e.clientX - rect.left;
            const y = e.clientY - rect.top;
            
            // Если выбрана башня для покупки
            if (selectedTowerType) {
                const price = parseInt(document.querySelector(`.tower-item[data-type="${selectedTowerType}"]`).getAttribute('data-price'));
                
                if (money >= price) {
                    // Проверяем, нет ли здесь уже башни
                    let canPlace = true;
                    for (const tower of towers) {
                        const dx = tower.x - x;
                        const dy = tower.y - y;
                        const distance = Math.sqrt(dx * dx + dy * dy);
                        
                        if (distance < TOWER_SIZE * 2) {
                            canPlace = false;
                            break;
                        }
                    }
                    
                    // Проверяем, не на пути ли башня и достаточно ли далеко от пути
                    const onPath = isOnPath(x, y);
                    
                    if (canPlace && !onPath) {
                        towers.push(new Tower(x, y, selectedTowerType));
                        money -= price;
                        updateStats();
                        selectedTowerType = null;
                        
                        // Снимаем выделение с кнопки
                        document.querySelectorAll('.tower-item').forEach(item => {
                            item.classList.remove('selected');
                        });
                    }
                } else {
                    alert('Недостаточно денег!');
                }
            } else {
                // Выбор существующей башни
                selectedTower = null;
                for (const tower of towers) {
                    const dx = tower.x - x;
                    const dy = tower.y - y;
                    const distance = Math.sqrt(dx * dx + dy * dy);
                    
                    if (distance < tower.size) {
                        selectedTower = tower;
                        
                        // Если у нас достаточно денег для улучшения, улучшаем
                        if (money >= tower.upgradeCost && !tower.upgraded) {
                            money -= tower.upgradeCost;
                            tower.upgrade();
                            updateStats();
                        }
                        
                        break;
                    }
                }
            }
        });
        
        // Проверка, находится ли точка на пути
        function isOnPath(x, y) {
            for (let i = 0; i < PATH.length - 1; i++) {
                const p1 = PATH[i];
                const p2 = PATH[i + 1];
                
                // Проверяем, находится ли точка рядом с отрезком пути
                const dist = pointToLineDistance(x, y, p1.x, p1.y, p2.x, p2.y);
                if (dist < 25) { // Ширина пути + запас
                    return true;
                }
            }
            return false;
        }
        
        // Вычисление расстояния от точки до отрезка
        function pointToLineDistance(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;
            
            const dot = A * C + B * D;
            const len_sq = C * C + D * D;
            let param = -1;
            
            if (len_sq !== 0) {
                param = dot / len_sq;
            }
            
            let xx, yy;
            
            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }
            
            const dx = px - xx;
            const dy = py - yy;
            
            return Math.sqrt(dx * dx + dy * dy);
        }
        
        // Обработчик выбора башни в магазине
        document.querySelectorAll('.tower-item').forEach(item => {
            item.addEventListener('click', function() {
                selectedTowerType = this.getAttribute('data-type');
                selectedTower = null;
                
                // Выделяем выбранную башню
                document.querySelectorAll('.tower-item').forEach(i => {
                    i.classList.remove('selected');
                });
                this.classList.add('selected');
            });
        });
        
        // Обработчик кнопки переключения отображения радиуса
        document.getElementById('toggleRadius').addEventListener('click', function() {
            showRadius = !showRadius;
            this.textContent = showRadius ? 'Скрыть радиус' : 'Показать радиус';
        });
        
        // Обработчик кнопки перезапуска
        document.getElementById('restartGame').addEventListener('click', function() {
            money = 100;
            lives = 20;
            wave = 0;
            enemies = [];
            towers = [];
            bullets = [];
            selectedTowerType = null;
            selectedTower = null;
            gameActive = true;
            waveActive = false;
            enemiesToSpawn = 0;
            this.style.display = 'none';
            document.getElementById('gameOverlay').style.display = 'none';
            
            // Снимаем выделение с кнопок
            document.querySelectorAll('.tower-item').forEach(item => {
                item.classList.remove('selected');
            });
            
            updateStats();
            gameLoop();
        });
        
        // Запуск игры
        updateStats();
        gameLoop();
    </script>
</body>
</html>
