<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>Tower Defense</title>
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: Arial, sans-serif;
    background-color: #2c3e50;
    color: #ecf0f1;
  }
  h1 { text-align: center; margin: 20px; color: #f1c40f; text-shadow: 2px 2px 4px rgba(0,0,0,0.5); }

  /* –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ */
#setupScreen {
  position: fixed; top:0; left:0; right:0; bottom:0;
  background: rgba(44,62,80,0.9);
  display:flex; justify-content:center; align-items:center; z-index:200;
}
.setup-container {
  background:#34495e; padding:30px; border-radius:10px; max-width:500px; width:90%; color:#ecf0f1;
}
.setup-container h2 { text-align:center; margin-bottom:20px; }

button {
  padding:10px 15px; margin-top:10px; border:none; border-radius:5px; cursor:pointer; font-weight:bold; transition:0.2s;
}
button:hover { opacity:0.8; }

#gameContainer {
  display:none; padding:10px 20px;
}
#statsBar {
  display:flex; justify-content:space-between; background:#34495e; padding:10px 20px; border-radius:8px; margin-bottom:10px;
  border:2px solid #f1c40f;
}
#statsBar span { font-weight:bold; color:#f1c40f; }

#canvasWrapper { position:relative; display:flex; align-items:flex-start; }
#gameCanvas {
  background-color:#27ae60; border:3px solid #f1c40f; border-radius:8px;
}
#controls {
  display:flex; flex-direction:column; gap:10px; margin-left:20px;
}
#toggleRadius, #toggleIndex {
  background:#2980b9; color:#fff;
}
#restartBtn {
  display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  background:#e74c3c; padding:20px; font-size:1.5em; border-radius:10px; cursor:pointer; z-index:300;
}
#gameOverlay {
  position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(0,0,0,0.7); display:none; justify-content:center; align-items:center; z-index:250;
}
/* –ú–∞–≥–∞–∑–∏–Ω */
#shopScreen {
  position:fixed; top:0; left:0; right:0; bottom:0; background:rgba(44,62,80,0.95); display:none; flex-direction:column; overflow-y:auto; padding:20px; z-index:300;
}
#shopContainer {
  background:#34495e; padding:20px; border-radius:10px; max-width:1000px; margin:0 auto; color:#ecf0f1;
}
#closeShop {
  float:right; font-size:1.5em; background:none; border:none; color:#e74c3c; cursor:pointer;
}
#categories {
  display:flex; gap:10px; margin-bottom:20px; flex-wrap:wrap;
}
.category {
  background:#2c3e50; padding:10px 15px; border-radius:5px; cursor:pointer; font-weight:bold; border:2px solid #555;
}
.category.active { background:#f1c40f; border-color:#f1c40f; color:#2c3e50; }
#shopItems {
  display:grid; grid-template-columns:repeat(auto-fit,minmax(250px,1fr)); gap:15px;
}
.shop-item {
  background:#2c3e50; padding:10px; border-radius:5px; display:flex; flex-direction:column; gap:10px; position:relative;
}
.shop-item h3 { margin-bottom:5px; border-bottom:2px solid #f1c40f; padding-bottom:5px; color:#f1c40f; }
#shopItemDetails { font-size:0.9em; color:#bdc3c7; }
#shopItemPrice { display:flex; justify-content:space-between; align-items:center; }
#buyBtn, #openCaseBtn {
  background:#2ecc71; padding:8px 12px; border:none; border-radius:4px; cursor:pointer; font-weight:bold;
}
#buyBtn:disabled, #openCaseBtn:disabled { background:#7f8c8d; cursor:not-allowed; }
#questionBtn {
  background:#2980b9; color:#fff; padding:2px 6px; border:none; border-radius:3px; cursor:pointer; font-size:0.9em;
}
#questionBtn:hover { background:#3498db; }
.case-content { display:none; margin-top:10px; background:#1abc9c; padding:10px; border-radius:5px; }
.enemyIndex {
  position:fixed; top:10px; right:10px; width:300px; max-height:90vh; overflow-y:auto; background:#34495e; border:2px solid #f1c40f; border-radius:8px; padding:10px; display:none; z-index:400;
}
.enemy-item { background:#2c3e50; padding:8px; margin-bottom:8px; border-radius:5px; border:1px solid #555; }
.enemy-item h4 { margin-bottom:4px; color:#f1c40f; }
</style>
</head>
<body>

<h1>Tower Defense</h1>

<!-- –≠–∫—Ä–∞–Ω –Ω–∞—á–∞–ª–∞ -->
<div id="setupScreen">
  <div class="setup-container">
    <h2>–ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∏–≥—Ä—ã</h2>
    <div>–î–µ–Ω—å–≥–∏: <span id="statsMoney">200</span></div>
    <div>–ñ–∏–∑–Ω–∏: <span id="statsLives">20</span></div>
    <div>–í–æ–ª–Ω–∞: <span id="statsWave">0</span></div>
    <div>–ê–ª–º–∞–∑—ã: <span id="statsDiamonds">0</span></div>
    <div style="margin-top:10px;">–í—ã–±–µ—Ä–∏—Ç–µ —Å–ª–æ–∂–Ω–æ—Å—Ç—å:</div>
    <button class="option-btn selected" id="diffNormal" data-difficulty="normal">–ö–ª–∞—Å—Å–∏–∫–∞</button>
    <button class="option-btn" id="diffHard" data-difficulty="hard">–°–ª–æ–∂–Ω—ã–π</button>
    <button class="option-btn" id="diffExtreme" data-difficulty="extreme">–≠–∫—Å—Ç—Ä–∏–º</button>
    <div style="margin-top:10px;">–ö–∞—Ä—Ç–∞:</div>
    <button class="option-btn selected" id="mapHills" data-map="hills">–•–æ–ª–º—ã</button>
    <button class="option-btn" id="mapFlat" data-map="flat">–†–æ–≤–Ω–∞—è –¥–æ—Ä–æ–≥–∞</button>
    <button class="option-btn" id="mapMountains" data-map="mountains">–ì–æ—Ä–∫–∏</button>
    <button id="startGameBtn" style="margin-top:20px;">–ù–∞—á–∞—Ç—å –∏–≥—Ä—É</button>
  </div>
</div>

<!-- –û—Å–Ω–æ–≤–Ω–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å -->
<div id="gameContainer" style="display:none;">
  <div id="statsBar">
    <div>
      –î–µ–Ω—å–≥–∏: <span id="money">200</span> |
      –ñ–∏–∑–Ω–∏: <span id="lives">20</span> |
      –í–æ–ª–Ω–∞: <span id="wave">0</span> |
      –ê–ª–º–∞–∑—ã: <span id="diamonds">0</span>
    </div>
    <div>
      <button id="toggleRadius">–°–∫—Ä—ã—Ç—å —Ä–∞–¥–∏—É—Å</button>
      <button id="toggleIndex">–ü–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤—Ä–∞–≥–æ–≤</button>
    </div>
  </div>
  <div style="display:flex; flex-wrap:wrap;">
    <div id="canvasWrapper">
      <canvas id="gameCanvas" width="800" height="500"></canvas>
    </div>
    <div style="margin-left:20px;">
      <button id="openShopBtn" style="margin-bottom:10px;">–ú–∞–≥–∞–∑–∏–Ω</button>
      <button id="restartBtn">–ü–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å</button>
      <div id="enemyIndex"></div>
    </div>
  </div>
</div>

<!-- –ú–∞–≥–∞–∑–∏–Ω -->
<div id="shopScreen">
  <div id="shopContainer">
    <button id="closeShop">√ó</button>
    <h2>–ú–∞–≥–∞–∑–∏–Ω</h2>
    <div id="categories">
      <div class="category active" data-category="difficulties">–°–ª–æ–∂–Ω–æ—Å—Ç–∏</div>
      <div class="category" data-category="maps">–ö–∞—Ä—Ç—ã</div>
      <div class="category" data-category="cases">–ö–µ–π—Å—ã</div>
    </div>
    <div id="shopItems">
      <!-- –°–ª–æ–∂–Ω–æ—Å—Ç–∏ -->
      <div class="shop-item" data-category="difficulties">
        <h3>–†–µ–∂–∏–º –≠–∫—Å—Ç—Ä–∏–º</h3>
        <p>–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç HP –≤—Ä–∞–≥–æ–≤ –∏ —Å–∫–æ—Ä–æ—Å—Ç—å</p>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>üíé 25</div>
          <button id="buyExtreme" data-price="25">–ö—É–ø–∏—Ç—å</button>
          <button class="question-btn" id="questionBtn-extreme">?</button>
        </div>
      </div>
      <!-- –ö–∞—Ä—Ç—ã -->
      <div class="shop-item" data-category="maps">
        <h3>–ö–∞—Ä—Ç–∞ –ì–æ—Ä–∫–∏</h3>
        <p>–ú–Ω–æ–≥–æ –ø–æ–≤–æ—Ä–æ—Ç–æ–≤ –∏ –∏–∑–≤–∏–ª–∏—Å—Ç—ã—Ö –ø—É—Ç–µ–π</p>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>üíé 20</div>
          <button id="buyMapMountains" data-price="20">–ö—É–ø–∏—Ç—å</button>
          <button class="question-btn" id="questionBtn-mountains">?</button>
        </div>
      </div>
      <!-- –ö–µ–π—Å—ã -->
      <div class="shop-item" data-category="cases">
        <h3>–û–±—ã—á–Ω—ã–π –∫–µ–π—Å</h3>
        <p>–®–∞–Ω—Å –ø–æ–ª—É—á–∏—Ç—å –±–∞—à–Ω—é</p>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>üíé 50</div>
          <button id="openNormalCase">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="question-btn" id="questionBtn-normal">?</button>
        </div>
        <div class="case-content">
          <div>–î–≤–æ–π–Ω–æ–π –ø–∏—Å—Ç–æ–ª–µ—Ç: 45%</div>
          <div>–ë–æ–º–±—ã: 30%</div>
          <div>–•–æ—Ä–æ—à–∞—è —Ñ–µ—Ä–º–∞: 20%</div>
          <div>–¢–æ–∫—Å–∏—á–Ω—ã–π: 4%</div>
          <div>–¢—É—Ä–µ–ª—å: 0.6%</div>
          <div>–ü—É—Å—Ç–æ–π: 0.4%</div>
        </div>
      </div>
      <div class="shop-item" data-category="cases">
        <h3>–ü—Ä–µ–º–∏—É–º –∫–µ–π—Å</h3>
        <p>–£–ª—É—á—à–µ–Ω–Ω—ã–µ —à–∞–Ω—Å—ã</p>
        <div style="display:flex; justify-content:space-between; align-items:center;">
          <div>üíé 200</div>
          <button id="openPremiumCase">–û—Ç–∫—Ä—ã—Ç—å</button>
          <button class="question-btn" id="questionBtn-premium">?</button>
        </div>
        <div class="case-content">
          <div>–ë–æ–º–±—ã: 40%</div>
          <div>–•–æ—Ä–æ—à–∞—è —Ñ–µ—Ä–º–∞: 25%</div>
          <div>–¢–æ–∫—Å–∏—á–Ω—ã–π: 20%</div>
          <div>–¢—É—Ä–µ–ª—å: 12.5%</div>
          <div>–ü—É—Å—Ç–æ–π: 2.5%</div>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- –°–∫—Ä–∏–ø—Ç -->
<script>
const canvas = document.getElementById('gameCanvas');
const ctx = canvas.getContext('2d');

let gameActive = false;
let towers = [];
let enemies = [];
let bullets = [];
let puddles = [];

let wave = 0;
let waveCounter=0; // –¥–ª—è –Ω–∞–≥—Ä–∞–¥
let waveMultiplier=1;
let waveRewardCount=5; // –∫–∞–∂–¥—ã–µ 5 –≤–æ–ª–Ω –Ω–∞–≥—Ä–∞–¥–∞
let enemySpawnTimer=0;

let maxEnemiesPerWave=15;

// –û–±—ä–µ–∫—Ç—ã –∑–Ω–∞–Ω–∏–π –≤—Ä–∞–≥–æ–≤
let enemyKnowledge = {
  'red': { health: 0, speed: 0, discovered: false },
  'purple': { health: 0, speed: 0, discovered: false },
  'golden': { health: 0, speed: 0, discovered: false },
  'pink': { health: 0, speed: 0, discovered: false },
  'green': { health: 0, speed: 0, discovered: false },
  'white': { health: 0, speed: 0, discovered: false },
  'boss': { health: 0, speed: 0, discovered: false },
  'blue': { health: 0, speed: 0, discovered: false },
  'sonic': { health: 0, speed: 0, discovered: false },
  'void': { health: 0, speed: 0, discovered: false }
};

let PATH = [];
let mapType='hills';

let difficulty='normal';

let showRadius=true;
let showIndex=false;

let selectedTowerType='pistol';
let selectedTower=null;

let rangeIndicator=null;

let stats = {
  money:200,
  lives:20,
  diamonds:0,
  wave:0
};

let bossAura=null;

// –ù–∞—á–∞–ª–æ
document.getElementById('startGameBtn').onclick=()=>{
  document.getElementById('setupScreen').style.display='none';
  document.getElementById('gameContainer').style.display='block';
  initGame();
  setPath();
  startWave();
  gameLoop();
};

// –ö–Ω–æ–ø–∫–∏ –º–µ–Ω—é
document.getElementById('openShopBtn').onclick=()=> {
  document.getElementById('shopScreen').style.display='flex';
};
document.getElementById('closeShop').onclick=()=>{
  document.getElementById('shopScreen').style.display='none';
};

// –í—ã–±–æ—Ä —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
document.getElementById('diffNormal').onclick=()=>selectDifficulty('normal');
document.getElementById('diffHard').onclick=()=>selectDifficulty('hard');
document.getElementById('diffExtreme').onclick=()=>selectDifficulty('extreme');
function selectDifficulty(diff) {
  difficulty=diff;
  document.querySelectorAll('.option-btn').forEach(btn=>btn.classList.remove('selected'));
  document.querySelectorAll('.option-btn').forEach(btn=>{
    if (btn.dataset.difficulty===diff) btn.classList.add('selected');
  });
}

// –í—ã–±–æ—Ä –∫–∞—Ä—Ç—ã
document.getElementById('mapHills').onclick=()=>selectMap('hills');
document.getElementById('mapFlat').onclick=()=>selectMap('flat');
document.getElementById('mapMountains').onclick=()=>selectMap('mountains');
function selectMap(map) {
  mapType=map;
  document.querySelectorAll('.option-btn').forEach(btn=>btn.classList.remove('selected'));
  document.querySelectorAll('.option-btn').forEach(btn=>{
    if (btn.dataset.map===map) btn.classList.add('selected');
  });
}

// –ù–∞—á–∞—Ç—å –∏–≥—Ä—É
document.getElementById('startGameBtn').onclick=()=>{
  document.getElementById('setupScreen').style.display='none';
  document.getElementById('gameContainer').style.display='block';
  initGame();
  setPath();
  startWave();
  gameLoop();
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
function initGame() {
  stats.money=200;
  stats.lives=20;
  stats.wave=0;
  stats.diamonds=0;
  updateStats();
  enemies.length=0;
  towers.length=0;
  bullets.length=0;
  puddles.length=0;
  wave=0; waveCounter=0; waveMultiplier=1;
}

// –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –ø—É—Ç–∏
function setPath() {
  if (mapType==='hills') {
    PATH = [
      {x:-20,y:250},
      {x:150,y:250},
      {x:150,y:150},
      {x:400,y:150},
      {x:400,y:350},
      {x:650,y:350},
      {x:650,y:250},
      {x:820,y:250}
    ];
  } else if (mapType==='flat') {
    PATH = [
      {x:-20,y:250},
      {x:820,y:250}
    ];
  } else if (mapType==='mountains') {
    PATH = [
      {x:-20,y:250},
      {x:100,y:250},
      {x:100,y:100},
      {x:200,y:100},
      {x:200,y:400},
      {x:300,y:400},
      {x:300,y:150},
      {x:500,y:150},
      {x:500,y:350},
      {x:700,y:350},
      {x:700,y:200},
      {x:820,y:200}
    ];
  }
}

// –í—Ä–∞–≥–∏
class Enemy {
  constructor(type) {
    this.type=type;
    this.health=getEnemyHealth(type);
    this.maxHealth=this.health;
    this.speed=getEnemySpeed(type);
    this.x=PATH[0].x;
    this.y=PATH[0].y;
    this.pathIndex=0;
    this.size=10;
    this.color=getEnemyColor(type);
    this.slowPercent=0;
    if (type==='boss') {
      this.health*=2; this.maxHealth=this.health;
    }
    // –∑–Ω–∞–Ω–∏—è –≤—Ä–∞–≥–æ–≤
    if (!enemyKnowledge[type].discovered) {
      enemyKnowledge[type].discovered=true;
      enemyKnowledge[type].health=this.health;
      enemyKnowledge[type].speed=this.speed;
    }
  }
  update() {
    // –æ—Å–æ–±–µ–Ω–Ω–æ—Å—Ç–∏ –≤—Ä–∞–≥–æ–≤
    if (this.type==='white') {
      this.speed= getEnemySpeed('white') + Math.random()*(getEnemySpeed('golden') - getEnemySpeed('white'));
    }
    if (this.type==='blue') {
      this.healTimer = (this.healTimer||0)+1;
      if (this.healTimer>=600) {
        this.healTimer=0;
        enemies.forEach(e=> {
          if (e!==this) e.health=Math.min(e.maxHealth,e.health+e.maxHealth*0.5);
        });
      }
    }
    if (this.type==='void') {
      this.deleteTimer = (this.deleteTimer||0)+1;
      if (this.deleteTimer>=3600) {
        this.deleteTimer=0;
        // —É–¥–∞–ª—è–µ—Ç —Å–ª—É—á–∞–π–Ω—É—é –±–∞—à–Ω—é –∫—Ä–æ–º–µ omega
        const nonOmega = towers.filter(t=>t.type!=='omega');
        if (nonOmega.length>0) {
          const t = nonOmega[Math.floor(Math.random()*nonOmega.length)];
          towers.splice(towers.indexOf(t),1);
        }
      }
    }
    // –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª—É–∂
    for (let p of puddles) {
      const dx=this.x - p.x;
      const dy=this.y - p.y;
      if (Math.sqrt(dx*dx+dy*dy)<p.radius) {
        this.takeDamage(p.damage);
      }
    }
    // –¥–≤–∏–∂–µ–Ω–∏–µ
    const target=PATH[this.pathIndex];
    const dx=target.x - this.x;
    const dy=target.y - this.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if (dist<this.speed) {
      this.x=target.x;
      this.y=target.y;
      this.pathIndex++;
      if (this.pathIndex>=PATH.length) {
        // –¥–æ—à–ª–∏
        stats.lives--;
        updateStats();
        if (stats.lives<=0) gameOver();
        return false;
      }
    } else {
      this.x+= (dx/dist)*this.speed;
      this.y+= (dy/dist)*this.speed;
    }
    return true;
  }
  draw() {
    ctx.fillStyle=this.color;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fill();
    // –∑–¥–æ—Ä–æ–≤—å–µ
    ctx.fillStyle='rgba(0,0,0,0.5)';
    ctx.fillRect(this.x-this.size,this.y-this.size-8,this.size*2,4);
    ctx.fillStyle=this.type==='golden'?'#00ff00':'red';
    ctx.fillRect(this.x-this.size,this.y-this.size-8,(this.health/this.maxHealth)*(this.size*2),4);
  }
  takeDamage(dmg) {
    this.health-=dmg;
    if (this.health<=0) {
      // –Ω–∞–≥—Ä–∞–¥–∞
      let reward=0;
      switch(this.type) {
        case 'red': reward=10; break;
        case 'purple': reward=25; break;
        case 'golden': reward=50; break;
        case 'pink': reward=30; break;
        case 'green': reward=75; break;
        case 'white': reward=100; break;
        case 'boss': reward=500+stats.wave*10; break;
        case 'blue': reward=150; break;
        case 'sonic': reward=200; break;
        case 'void': reward=1000; break;
      }
      stats.diamonds+=reward;
      updateStats();
      return false;
    }
    return true;
  }
}

// –®–∞–Ω—Å –∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –≤—Ä–∞–≥–æ–≤
function getEnemyHealth(type) {
  if (type==='red') return 3+Math.floor(stats.wave/3);
  if (type==='purple') return 15;
  if (type==='golden') return 35;
  if (type==='pink') return 11;
  if (type==='green') return 100;
  if (type==='white') return 120;
  if (type==='boss') return 250+stats.wave*10;
  if (type==='blue') return 200;
  if (type==='sonic') return 10;
  if (type==='void') return 1000;
}
function getEnemySpeed(type) {
  if (type==='red') return 1;
  if (type==='purple') return 0.8;
  if (type==='golden') return 1.2;
  if (type==='pink') return 0.7;
  if (type==='green') return 0.9;
  if (type==='white') return 0.5;
  if (type==='boss') return 1;
  if (type==='blue') return 0.6;
  if (type==='sonic') return 2;
  if (type==='void') return 0.8;
}
function getEnemyColor(type) {
  if (type==='red') return 'red';
  if (type==='purple') return 'purple';
  if (type==='golden') return 'gold';
  if (type==='pink') return 'pink';
  if (type==='green') return 'green';
  if (type==='white') return 'white';
  if (type==='boss') return 'black';
  if (type==='blue') return 'blue';
  if (type==='sonic') return 'yellow';
  if (type==='void') return 'violet';
}

// –ë–∞—à–Ω–∏
class Tower {
  constructor(x,y,type) {
    this.x=x; this.y=y; this.type=type;
    this.upgraded=false;
    this.cooldown=0;
    this.innerRadius=0;
    this.outerRadius=0;
    this.innerDamage=0;
    this.outerDamage=0;
    this.innerFireRate=0;
    this.outerFireRate=0;
    this.slowPercent=0;
    this.specialChance=0;
    this.specialDamage=0;
    this.specialRate=0;
    this.income=0;
    this.incomeRate=60;
    this.size=15;
    this.targeting='first';

    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –ø–æ —Ç–∏–ø—É
    switch(type) {
      case 'pistol':
        this.radius=10*10; this.damage=1; this.fireRate=60; this.color='blue'; break;
      case 'swordsman':
        this.radius=4*10; this.damage=1; this.fireRate=30; this.color='red'; break;
      case 'sniper':
        this.radius=100*10; this.damage=10; this.fireRate=300; this.color='purple'; break;
      case 'freezer':
        this.radius=25*10; this.damage=1; this.fireRate=300; this.slowPercent=10; this.color='lightblue'; break;
      case 'knight':
        this.innerRadius=5*10; this.outerRadius=28*10;
        this.innerDamage=5; this.outerDamage=5;
        this.innerFireRate=36; this.outerFireRate=114;
        this.color='orange'; break;
      case 'farm':
        this.income=1; this.incomeRate=60; this.color='brown'; break;
      case 'chance':
        this.radius=17*10; this.minDamage=7; this.maxDamage=17; this.fireRate=42; this.color='magenta'; break;
      case 'atomic':
        this.radius=100*10; this.damage=200; this.fireRate=3600; this.color='darkgreen'; break;
      case 'omega':
        this.innerRadius=9*10; this.outerRadius=30*10;
        this.innerDamage=10; this.outerDamage=25;
        this.innerFireRate=30; this.outerFireRate=180;
        this.color='gold'; break;
      case 'doublepistol':
        this.radius=10*10; this.damage=2; this.fireRate=60; this.color='lightblue'; break;
      case 'bomb':
        this.radius=8*10; this.damage=5; this.fireRate=150; this.aoe=true; this.aoeRadius=13*10; this.color='black'; break;
      case 'goodfarm':
        this.income=5; this.incomeRate=60; this.color='green'; break;
      case 'toxic':
        this.damage=1; this.fireRate=6; this.puddleRate=180; this.puddleDamage=1; this.puddleRadius=5*10; this.puddleDuration=300; this.color='lime'; break;
      case 'turret':
        this.radius=15*10; this.damage=2; this.fireRate=12; this.color='gray'; break;
      case 'empty':
        this.radius=10*10; this.damage=10; this.fireRate=60; this.slowPercent=50; this.specialChance=0.041; this.specialDamage=25; this.specialRate=600; this.color='purple'; break;
    }
  }
  update() {
    // –¥–æ—Ö–æ–¥
    if (this.type==='farm' || this.type==='goodfarm') {
      this.incomeCount = (this.incomeCount||0)+1;
      if (this.incomeCount>=this.incomeRate) {
        this.incomeCount=0;
        stats.money+=this.income;
        updateStats();
      }
      return;
    }
    // –ª–æ–≤—É—à–∫–∏
    if (this.type==='toxic') {
      this.puddleCount = (this.puddleCount||0)+1;
      if (this.puddleCount>=this.puddleRate) {
        this.puddleCount=0;
        puddles.push(new Puddle(this.x,this.y,this.puddleDamage,this.puddleRadius,this.puddleDuration));
      }
      return;
    }
    // —Å—Ç—Ä–µ–ª—å–±–∞
    if (this.type==='omega') {
      this.innerCooldown=(this.innerCooldown||0)-1;
      this.outerCooldown=(this.outerCooldown||0)-1;
    }
    let enemiesInRange=[];
    for (let e of enemies) {
      const dx=e.x - this.x;
      const dy=e.y - this.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if (this.type==='knight'||this.type==='omega') {
        if (dist<this.outerRadius) enemiesInRange.push(e);
      } else {
        if (dist<this.radius) enemiesInRange.push(e);
      }
    }
    if (enemiesInRange.length>0) {
      let target;
      if (this.targeting==='first') {
        target=enemiesInRange[0];
        for (let e of enemiesInRange) {
          if (e.pathIndex>target.pathIndex) target=e;
        }
      } else {
        target=enemiesInRange[Math.floor(Math.random()*enemiesInRange.length)];
      }
      if (this.type==='knight'||this.type==='omega') {
        const dx=target.x - this.x;
        const dy=target.y - this.y;
        const dist=Math.sqrt(dx*dx+dy*dy);
        if (dist<this.innerRadius && (this.innerCooldown||0)<=0) {
          bullets.push({x:this.x,y:this.y,target:target,damage:this.innerDamage,speed:8,size:5,color:this.innerColor||'orange'});
          this.innerCooldown=this.innerFireRate;
        }
        if (dist>=this.innerRadius && (this.outerCooldown||0)<=0) {
          bullets.push({x:this.x,y:this.y,target:target,damage:this.outerDamage,speed:5,size:5,color:this.outerColor||'orange'});
          this.outerCooldown=this.outerFireRate;
        }
      } else if (this.type==='freezer') {
        if ((this.cooldown||0)<=0) {
          for (let e of enemiesInRange) e.slowPercent=Math.max(e.slowPercent||0,this.slowPercent);
          bullets.push({x:this.x,y:this.y,target:target,damage:this.damage,speed:5,size:5,color:'lightblue'});
          this.cooldown=this.fireRate;
        }
      } else if (this.type==='chance') {
        if ((this.cooldown||0)<=0) {
          const dmg=Math.random()*(this.maxDamage - this.minDamage)+this.minDamage;
          bullets.push({x:this.x,y:this.y,target:target,damage:dmg,speed:6,size:5,color:'magenta'});
          this.cooldown=this.fireRate;
        }
      } else if (this.type==='sniper') {
        if ((this.cooldown||0)<=0) {
          bullets.push({x:this.x,y:this.y,target:target,damage:this.damage,speed:1000,size:5,color:'yellow',instant:true});
          this.cooldown=this.fireRate;
        }
      } else if (this.type==='bomb') {
        if ((this.cooldown||0)<=0) {
          bullets.push({x:this.x,y:this.y,target:target,damage:this.damage,speed:5,size:7,color:'black',aoe:true,aoeRadius:this.aoeRadius});
          this.cooldown=this.fireRate;
        }
      } else if (this.type==='empty') {
        if ((this.cooldown||0)<=0) {
          for (let e of enemiesInRange) e.slowPercent=Math.max(e.slowPercent||0,this.slowPercent);
          bullets.push({x:this.x,y:this.y,target:target,damage:this.damage,speed:5,size:5,color:'purple'});
          this.cooldown=this.fireRate;
        }
      } else {
        if ((this.cooldown||0)<=0) {
          bullets.push({x:this.x,y:this.y,target:target,damage:this.damage,speed:5,size:5,color:this.type==='doublepistol'?this.secondColor||'lightblue':'cyan'});
          this.cooldown=this.fireRate;
        }
      }
    }
    if (this.cooldown>0) this.cooldown--;
    if (this.type==='omega') {
      this.innerCooldown=(this.innerCooldown||0)-1;
      this.outerCooldown=(this.outerCooldown||0)-1;
    }
  }
  draw() {
    ctx.fillStyle=this.color;
    ctx.beginPath();
    ctx.arc(this.x,this.y,this.size,0,Math.PI*2);
    ctx.fill();
    if ((selectedTower===this || selectedTowerType===this.type) && showRadius) {
      ctx.strokeStyle='rgba(255,255,255,0.5)';
      ctx.setLineDash([5,5]);
      if (this.type==='knight'||this.type==='omega') {
        ctx.beginPath(); ctx.arc(this.x,this.y,this.innerRadius,0,Math.PI*2); ctx.stroke();
        ctx.beginPath(); ctx.arc(this.x,this.y,this.outerRadius,0,Math.PI*2); ctx.stroke();
      } else if (this.type==='farm'||this.type==='goodfarm'||this.type==='toxic') {
        ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.stroke();
      }
      ctx.setLineDash([]);
    }
  }
}

class Puddle {
  constructor(x,y,damage,radius,duration) {
    this.x=x; this.y=y; this.damage=damage; this.radius=radius; this.duration=duration; this.counter=0;
  }
  update() {
    this.counter++;
    return this.counter<this.duration;
  }
  draw() {
    ctx.fillStyle='rgba(0,255,0,0.3)';
    ctx.beginPath(); ctx.arc(this.x,this.y,this.radius,0,Math.PI*2); ctx.fill();
  }
}

function updateStats() {
  document.getElementById('money').innerText=stats.money;
  document.getElementById('lives').innerText=stats.lives;
  document.getElementById('wave').innerText=stats.wave;
  document.getElementById('diamonds').innerText=stats.diamonds;
}

// –ù–∞—á–∞—Ç—å –≤–æ–ª–Ω—É
function startWave() {
  stats.wave++;
  document.getElementById('statsWave').innerText=stats.wave;
  // –Ω–∞–≥—Ä–∞–¥—ã
  let reward=0;
  stats.diamonds+=1;
  if (difficulty==='hard') stats.diamonds+=2;
  if (difficulty==='extreme') stats.diamonds+=3;
  waveCounter++;
  if (waveCounter>=waveRewardCount) {
    stats.diamonds+=waveCounter*2;
    waveCounter=0;
  }
  updateStats();

  // –ú–Ω–æ–∂–∏—Ç–µ–ª—å
  if (stats.wave%5===0) waveMultiplier*=2;

  // –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –≤—Ä–∞–≥–æ–≤
  enemiesToSpawn=5+Math.floor(stats.wave/2);
  enemySpawnTimer=0;
}

// –í—Ä–µ–º—è —Å–ø–∞–≤–Ω–∞ –≤—Ä–∞–≥–æ–≤
function spawnEnemies() {
  if (enemies.length>=maxEnemiesPerWave) return;
  if (enemiesToSpawn>0) {
    enemySpawnTimer++;
    if (enemySpawnTimer>=60) {
      enemySpawnTimer=0;
      let type='red';
      if (stats.wave>=3 && Math.random()<0.1) type='purple';
      if (stats.wave>=5 && Math.random()<0.05) type='golden';
      if (stats.wave>=8 && Math.random()<0.03) type='pink';
      if (stats.wave>=10 && Math.random()<0.02) type='green';
      if (stats.wave>=15 && Math.random()<0.01) type='white';
      if (stats.wave>=20 && Math.random()<0.005) type='boss';
      if (stats.wave>=12 && Math.random()<0.04) type='blue';
      if (stats.wave>=14 && Math.random()<0.02) type='sonic';
      if (stats.wave>=16 && Math.random()<0.01) type='void';

      enemies.push(new Enemy(type));
      enemiesToSpawn--;
    }
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤ –ø–æ –∫–∞—Ä—Ç–µ
canvas.addEventListener('click', e => {
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(canvas.width/rect.width);
  const y=(e.clientY-rect.top)*(canvas.height/rect.height);
  // –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –±–∞—à–Ω—è
  let clickedTower=null;
  for (let t of towers) {
    if (Math.sqrt((t.x - x)**2+(t.y - y)**2)<t.size+5) {
      clickedTower=t; break;
    }
  }
  if (clickedTower) {
    showUpgradeMenu(clickedTower,x,y);
  } else {
    // –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –±–∞—à–Ω—é
    if (stats.money>=50) {
      stats.money-=50;
      updateStats();
      towers.push(new Tower(x,y,'pistol'));
    }
  }
});

// –ü—Ä–æ—Å—Ç–æ–µ –º–µ–Ω—é
function showUpgradeMenu(tower,x,y) {
  alert('–ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏—è –∏ –ø—Ä–æ–¥–∞–∂–∏ –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å.');
}

// –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É
function updateStats() {
  document.getElementById('money').innerText=stats.money;
  document.getElementById('lives').innerText=stats.lives;
  document.getElementById('wave').innerText=stats.wave;
  document.getElementById('diamonds').innerText=stats.diamonds;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø—É–ª—å
function updateBullets() {
  for (let i=bullets.length-1;i>=0;i--) {
    const b=bullets[i];
    if (b.instant) {
      if (b.target.takeDamage(b.damage)) {
        // –≤—Ä–∞–≥ —É–º–µ—Ä
        enemies.splice(enemies.indexOf(b.target),1);
      }
      bullets.splice(i,1);
      continue;
    }
    if (b.aoe && b.target) {
      const dx=b.target.x - b.x;
      const dy=b.target.y - b.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if (dist<b.speed) {
        // –≤–∑—Ä—ã–≤
        for (let e of enemies) {
          const dx2=e.x - b.target.x;
          const dy2=e.y - b.target.y;
          if (Math.sqrt(dx2*dx2+dy2*dy2)<b.aoeRadius) {
            if (e.takeDamage(b.damage)) {
              enemies.splice(enemies.indexOf(e),1);
            }
          }
        }
        bullets.splice(i,1);
        continue;
      }
    }
    // –ª–µ—Ç–∏—Ç
    const dx=b.target.x - b.x;
    const dy=b.target.y - b.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if (dist<b.speed) {
      if (b.target.takeDamage(b.damage)) {
        enemies.splice(enemies.indexOf(b.target),1);
      }
      bullets.splice(i,1);
    } else {
      b.x+= (dx/dist)*b.speed;
      b.y+= (dy/dist)*b.speed;
    }
  }
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
function updateEnemyIndex() {
  const container=document.getElementById('enemyIndex');
  container.innerHTML='';
  for (let e of enemies) {
    const div=document.createElement('div');
    div.className='enemy-item';
    div.innerHTML=`<h4>–¢–∏–ø: ${e.type}</h4>hp:${Math.round(e.health)}/${e.maxHealth}<br/>pos: (${Math.round(e.x)},${Math.round(e.y)})<br/>–ü—É—Ç—å: ${e.pathIndex}`;
    container.appendChild(div);
  }
  container.style.display='block';
}

// –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawPath();

  // –≤—Ä–∞–≥–∏
  for (let i=enemies.length-1;i>=0;i--) {
    if (!enemies[i].update()) enemies.splice(i,1);
  }

  for (let e of enemies) e.draw();

  // –±–∞—à–Ω–∏
  for (let t of towers) {
    t.update();
    t.draw();
  }

  // –ø—É–ª–∏
  updateBullets();

  // –ª—É–∂–∏
  for (let p of puddles) {
    if (!p.update()) {
      puddles.splice(puddles.indexOf(p),1);
    } else {
      p.draw();
    }
  }

  // –∑–∞–ø—É—Å–∫ –≤—Ä–∞–≥–æ–≤
  spawnEnemies();

  // –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤—Ä–∞–≥–æ–≤
  if (showIndex) updateEnemyIndex();

  // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
  if (gameActive) requestAnimationFrame(gameLoop);
}

// –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ø—É—Ç—å
function drawPath() {
  ctx.strokeStyle='#f1c40f';
  ctx.lineWidth=30;
  ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(PATH[0].x,PATH[0].y);
  for (let i=1;i<PATH.length;i++) ctx.lineTo(PATH[i].x,PATH[i].y);
  ctx.stroke();
  ctx.strokeStyle='#d35400'; ctx.lineWidth=2; ctx.setLineDash([5,15]);
  ctx.beginPath();
  ctx.moveTo(PATH[0].x,PATH[0].y);
  for (let i=1;i<PATH.length;i++) ctx.lineTo(PATH[i].x,PATH[i].y);
  ctx.stroke();
  ctx.setLineDash([]);
}

// –í—Ä–µ–º—è —Å–ø–∞–≤–Ω–∞ –≤—Ä–∞–≥–æ–≤
function spawnEnemies() {
  if (enemies.length>=maxEnemiesPerWave) return;
  if (enemiesToSpawn>0) {
    enemySpawnTimer++;
    if (enemySpawnTimer>=60) {
      enemySpawnTimer=0;
      let type='red';
      // –≤–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç—å –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤–æ–ª–Ω—ã
      if (stats.wave>=3 && Math.random()<0.1) type='purple';
      if (stats.wave>=5 && Math.random()<0.05) type='golden';
      if (stats.wave>=8 && Math.random()<0.03) type='pink';
      if (stats.wave>=10 && Math.random()<0.02) type='green';
      if (stats.wave>=15 && Math.random()<0.01) type='white';
      if (stats.wave>=20 && Math.random()<0.005) type='boss';
      if (stats.wave>=12 && Math.random()<0.04) type='blue';
      if (stats.wave>=14 && Math.random()<0.02) type='sonic';
      if (stats.wave>=16 && Math.random()<0.01) type='void';

      enemies.push(new Enemy(type));
      enemiesToSpawn--;
    }
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
canvas.addEventListener('click', e => {
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(canvas.width/rect.width);
  const y=(e.clientY-rect.top)*(canvas.height/rect.height);
  // –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –±–∞—à–Ω—è
  let clickedTower=null;
  for (let t of towers) {
    if (Math.sqrt((t.x - x)**2+(t.y - y)**2)<t.size+5) {
      clickedTower=t; break;
    }
  }
  if (clickedTower) {
    showUpgradeMenu(clickedTower,x,y);
  } else {
    // –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –±–∞—à–Ω—é
    if (stats.money>=50) {
      stats.money-=50;
      updateStats();
      towers.push(new Tower(x,y,'pistol'));
    }
  }
});

// –ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏—è/–ø—Ä–æ–¥–∞–∂–∏
function showUpgradeMenu(tower,x,y) {
  alert('–ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏–π –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ. –ú–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å.');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats() {
  document.getElementById('money').innerText=stats.money;
  document.getElementById('lives').innerText=stats.lives;
  document.getElementById('wave').innerText=stats.wave;
  document.getElementById('diamonds').innerText=stats.diamonds;
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤
function updateEnemyIndex() {
  const container=document.getElementById('enemyIndex');
  container.innerHTML='';
  for (let e of enemies) {
    const div=document.createElement('div');
    div.className='enemy-item';
    div.innerHTML=`<h4>–¢–∏–ø: ${e.type}</h4>hp:${Math.round(e.health)}/${e.maxHealth}<br/>pos: (${Math.round(e.x)},${Math.round(e.y)})<br/>–ü—É—Ç—å: ${e.pathIndex}`;
    container.appendChild(div);
  }
  container.style.display='block';
}

// –ö–Ω–æ–ø–∫–∏ —Ä–∞–¥–∏—É—Å–∞ –∏ –∏–Ω–¥–µ–∫—Å–∞
document.getElementById('toggleRadius').onclick=()=>{
  showRadius=!showRadius;
  document.getElementById('toggleRadius').innerText=showRadius?'–°–∫—Ä—ã—Ç—å —Ä–∞–¥–∏—É—Å':'–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–¥–∏—É—Å';
};
document.getElementById('toggleIndex').onclick=()=>{
  showIndex=!showIndex;
  document.getElementById('enemyIndex').style.display=showIndex?'block':'none';
};

// –ü–µ—Ä–µ–∑–∞–ø—É—Å–∫
document.getElementById('restartBtn').onclick=()=>{
  initGame();
  startWave();
  gameLoop();
  document.getElementById('gameOverlay').style.display='none';
  document.getElementById('restartBtn').style.display='none';
};

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –ø–æ–∫—É–ø–æ–∫ –∫–µ–π—Å–æ–≤ –∑–∞ –∞–ª–º–∞–∑—ã
document.getElementById('openNormalCase').onclick=()=>{
  if (stats.diamonds>=50) {
    stats.diamonds-=50;
    updateStats();
    openCase('normal');
  } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤');
};
document.getElementById('openPremiumCase').onclick=()=>{
  if (stats.diamonds>=200) {
    stats.diamonds-=200;
    updateStats();
    openCase('premium');
  } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤');
};
document.getElementById('buyExtreme').onclick=()=>{
  if (stats.diamonds>=25) {
    stats.diamonds-=25;
    updateStats();
    selectDifficulty('extreme');
  } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤');
};
document.getElementById('buyMapMountains').onclick=()=>{
  if (stats.diamonds>=20) {
    stats.diamonds-=20;
    updateStats();
    selectMap('mountains');
    setPath();
  } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤');
};

// –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞
function openCase(type='normal') {
  const rand=Math.random()*100;
  let item=null;
  if (type==='normal') {
    if (rand<=45) item='doublepistol';
    else if (rand<=75) item='bomb';
    else if (rand<=95) item='farm';
    else if (rand<=99) item='toxic';
    else if (rand<=99.6) item='turret';
    else item='empty';
  } else {
    // –ø—Ä–µ–º–∏—É–º
    if (rand<=40) item='bomb';
    else if (rand<=65) item='farm';
    else if (rand<=85) item='toxic';
    else if (rand<=97.5) item='turret';
    else item='empty';
  }
  // –¥–æ–±–∞–≤–ª—è–µ–º –±–∞—à–Ω—é
  switch(item) {
    case 'doublepistol':
      towers.push(new Tower(150,150,'doublepistol'));
      break;
    case 'bomb':
      towers.push(new Tower(200,200,'bomb'));
      break;
    case 'farm':
      towers.push(new Tower(250,250,'farm'));
      break;
    case 'toxic':
      towers.push(new Tower(300,300,'toxic'));
      break;
    case 'turret':
      towers.push(new Tower(350,350,'turret'));
      break;
    case 'empty':
      towers.push(new Tower(400,400,'empty'));
      break;
  }
}

// –í –æ—Å–Ω–æ–≤–Ω–æ–º —Ü–∏–∫–ª–µ
function gameLoop() {
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawPath();

  // –≤—Ä–∞–≥–∏
  for (let i=enemies.length-1;i>=0;i--) {
    if (!enemies[i].update()) enemies.splice(i,1);
  }

  for (let e of enemies) e.draw();

  // –±–∞—à–Ω–∏
  for (let t of towers) {
    t.update();
    t.draw();
  }

  // –ø—É–ª–∏
  updateBullets();

  // –ª—É–∂–∏
  for (let p of puddles) {
    if (!p.update()) {
      puddles.splice(puddles.indexOf(p),1);
    } else {
      p.draw();
    }
  }

  // —Å–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤
  spawnEnemies();

  // –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤—Ä–∞–≥–æ–≤
  if (showIndex) updateEnemyIndex();

  // –ø–µ—Ä–µ–∑–∞–ø—É—Å–∫
  if (gameActive) requestAnimationFrame(gameLoop);
}

// –û—Ç—Ä–∏—Å–æ–≤–∞—Ç—å –ø—É—Ç—å
function drawPath() {
  ctx.strokeStyle='#f1c40f';
  ctx.lineWidth=30;
  ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(PATH[0].x,PATH[0].y);
  for (let i=1;i<PATH.length;i++) ctx.lineTo(PATH[i].x,PATH[i].y);
  ctx.stroke();
  ctx.strokeStyle='#d35400'; ctx.lineWidth=2; ctx.setLineDash([5,15]);
  ctx.beginPath();
  ctx.moveTo(PATH[0].x,PATH[0].y);
  for (let i=1;i<PATH.length;i++) ctx.lineTo(PATH[i].x,PATH[i].y);
  ctx.stroke();
  ctx.setLineDash([]);
}

// –í—Ä–µ–º—è –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤
function spawnEnemies() {
  if (enemies.length>=maxEnemiesPerWave) return;
  if (enemiesToSpawn>0) {
    enemySpawnTimer++;
    if (enemySpawnTimer>=60) {
      enemySpawnTimer=0;
      let type='red';
      if (stats.wave>=3 && Math.random()<0.1) type='purple';
      if (stats.wave>=5 && Math.random()<0.05) type='golden';
      if (stats.wave>=8 && Math.random()<0.03) type='pink';
      if (stats.wave>=10 && Math.random()<0.02) type='green';
      if (stats.wave>=15 && Math.random()<0.01) type='white';
      if (stats.wave>=20 && Math.random()<0.005) type='boss';
      if (stats.wave>=12 && Math.random()<0.04) type='blue';
      if (stats.wave>=14 && Math.random()<0.02) type='sonic';
      if (stats.wave>=16 && Math.random()<0.01) type='void';

      enemies.push(new Enemy(type));
      enemiesToSpawn--;
    }
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
canvas.addEventListener('click', e => {
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(canvas.width/rect.width);
  const y=(e.clientY-rect.top)*(canvas.height/rect.height);
  // –ø—Ä–æ–≤–µ—Ä–∏—Ç—å, –µ—Å—Ç—å –ª–∏ –±–∞—à–Ω—è
  let clickedTower=null;
  for (let t of towers) {
    if (Math.sqrt((t.x - x)**2+(t.y - y)**2)<t.size+5) {
      clickedTower=t; break;
    }
  }
  if (clickedTower) {
    showUpgradeMenu(clickedTower,x,y);
  } else {
    // –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –±–∞—à–Ω—é
    if (stats.money>=50) {
      stats.money-=50;
      updateStats();
      towers.push(new Tower(x,y,'pistol'));
    }
  }
});

// –ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏—è –∏ –ø—Ä–æ–¥–∞–∂–∏
function showUpgradeMenu(tower,x,y) {
  alert('–ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏–π –∏ –ø—Ä–æ–¥–∞–∂–∏ ‚Äî –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ.');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats() {
  document.getElementById('money').innerText=stats.money;
  document.getElementById('lives').innerText=stats.lives;
  document.getElementById('wave').innerText=stats.wave;
  document.getElementById('diamonds').innerText=stats.diamonds;
}

// –ü—É–ª–∏
function updateBullets() {
  for (let i=bullets.length-1;i>=0;i--) {
    const b=bullets[i];
    if (b.instant) {
      if (b.target.takeDamage(b.damage)) {
        enemies.splice(enemies.indexOf(b.target),1);
      }
      bullets.splice(i,1);
      continue;
    }
    if (b.aoe && b.target) {
      const dx=b.target.x - b.x;
      const dy=b.target.y - b.y;
      const dist=Math.sqrt(dx*dx+dy*dy);
      if (dist<b.speed) {
        for (let e of enemies) {
          const dx2=e.x - b.target.x;
          const dy2=e.y - b.target.y;
          if (Math.sqrt(dx2*dx2+dy2*dy2)<b.aoeRadius) {
            if (e.takeDamage(b.damage)) {
              enemies.splice(enemies.indexOf(e),1);
            }
          }
        }
        bullets.splice(i,1);
        continue;
      }
    }
    // –ª–µ—Ç–∏—Ç
    const dx=b.target.x - b.x;
    const dy=b.target.y - b.y;
    const dist=Math.sqrt(dx*dx+dy*dy);
    if (dist<b.speed) {
      if (b.target.takeDamage(b.damage)) {
        enemies.splice(enemies.indexOf(b.target),1);
      }
      bullets.splice(i,1);
    } else {
      b.x+= (dx/dist)*b.speed;
      b.y+= (dy/dist)*b.speed;
    }
  }
}

// –û–±–Ω–æ–≤–∏—Ç—å –∏–Ω–¥–µ–∫—Å –≤—Ä–∞–≥–æ–≤
function updateEnemyIndex() {
  const container=document.getElementById('enemyIndex');
  container.innerHTML='';
  for (let e of enemies) {
    const div=document.createElement('div');
    div.className='enemy-item';
    div.innerHTML=`<h4>–¢–∏–ø: ${e.type}</h4>hp:${Math.round(e.health)}/${e.maxHealth}<br/>pos: (${Math.round(e.x)},${Math.round(e.y)})<br/>–ø—É—Ç—å:${e.pathIndex}`;
    container.appendChild(div);
  }
  container.style.display='block';
}

// –û—Å–Ω–æ–≤–Ω–æ–π —Ü–∏–∫–ª
let gameRunning=true;
function gameLoop() {
  if (!gameRunning) return;
  ctx.clearRect(0,0,canvas.width,canvas.height);
  drawPath();

  // –≤—Ä–∞–≥–∏
  for (let i=enemies.length-1;i>=0;i--) {
    if (!enemies[i].update()) enemies.splice(i,1);
  }
  for (let e of enemies) e.draw();

  // –±–∞—à–Ω–∏
  for (let t of towers) {
    t.update();
    t.draw();
  }
  // –ø—É–ª–∏
  updateBullets();

  // –ª—É–∂–∏
  for (let p of puddles) {
    if (!p.update()) {
      puddles.splice(puddles.indexOf(p),1);
    } else {
      p.draw();
    }
  }

  // –∑–∞–ø—É—Å–∫ –≤—Ä–∞–≥–æ–≤
  spawnEnemies();

  // –ø–æ–∫–∞–∑–∞—Ç—å –∏–Ω–¥–µ–∫—Å –≤—Ä–∞–≥–æ–≤
  if (showIndex) updateEnemyIndex();

  requestAnimationFrame(gameLoop);
}

// –ù–∞—Ä–∏—Å–æ–≤–∞—Ç—å –ø—É—Ç—å
function drawPath() {
  ctx.strokeStyle='#f1c40f';
  ctx.lineWidth=30;
  ctx.lineJoin='round'; ctx.lineCap='round';
  ctx.beginPath();
  ctx.moveTo(PATH[0].x,PATH[0].y);
  for (let i=1;i<PATH.length;i++) ctx.lineTo(PATH[i].x,PATH[i].y);
  ctx.stroke();
  ctx.strokeStyle='#d35400'; ctx.lineWidth=2; ctx.setLineDash([5,15]);
  ctx.beginPath();
  ctx.moveTo(PATH[0].x,PATH[0].y);
  for (let i=1;i<PATH.length;i++) ctx.lineTo(PATH[i].x,PATH[i].y);
  ctx.stroke();
  ctx.setLineDash([]);
}

// –í—Ä–µ–º—è –ø–æ—è–≤–ª–µ–Ω–∏—è –≤—Ä–∞–≥–æ–≤
function spawnEnemies() {
  if (enemies.length>=maxEnemiesPerWave) return;
  if (enemiesToSpawn>0) {
    enemySpawnTimer++;
    if (enemySpawnTimer>=60) {
      enemySpawnTimer=0;
      let type='red';
      if (stats.wave>=3 && Math.random()<0.1) type='purple';
      if (stats.wave>=5 && Math.random()<0.05) type='golden';
      if (stats.wave>=8 && Math.random()<0.03) type='pink';
      if (stats.wave>=10 && Math.random()<0.02) type='green';
      if (stats.wave>=15 && Math.random()<0.01) type='white';
      if (stats.wave>=20 && Math.random()<0.005) type='boss';
      if (stats.wave>=12 && Math.random()<0.04) type='blue';
      if (stats.wave>=14 && Math.random()<0.02) type='sonic';
      if (stats.wave>=16 && Math.random()<0.01) type='void';

      enemies.push(new Enemy(type));
      enemiesToSpawn--;
    }
  }
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–æ–≤
canvas.addEventListener('click', e => {
  const rect=canvas.getBoundingClientRect();
  const x=(e.clientX-rect.left)*(canvas.width/rect.width);
  const y=(e.clientY-rect.top)*(canvas.height/rect.height);

  // –Ω–∞–π—Ç–∏ –±–∞—à–Ω—é
  let clickedTower=null;
  for (let t of towers) {
    if (Math.sqrt((t.x - x)**2+(t.y - y)**2)<t.size+5) {
      clickedTower=t; break;
    }
  }

  if (clickedTower) {
    showUpgradeMenu(clickedTower,x,y);
  } else {
    // –ø–æ—Å—Ç—Ä–æ–∏—Ç—å –±–∞—à–Ω—é
    if (stats.money>=50) {
      stats.money-=50;
      updateStats();
      towers.push(new Tower(x,y,'pistol'));
    }
  }
});

// –ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏—è/–ø—Ä–æ–¥–∞–∂–∏
function showUpgradeMenu(tower,x,y) {
  alert('–ú–µ–Ω—é —É–ª—É—á—à–µ–Ω–∏–π –∏ –ø—Ä–æ–¥–∞–∂–∏ ‚Äî –Ω–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ.');
}

// –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏
function updateStats() {
  document.getElementById('money').innerText=stats.money;
  document.getElementById('lives').innerText=stats.lives;
  document.getElementById('wave').innerText=stats.wave;
  document.getElementById('diamonds').innerText=stats.diamonds;
}

// –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ä–∞–¥–∏—É—Å–æ–≤ –∏ –∏–Ω–¥–µ–∫—Å–∞
document.getElementById('toggleRadius').onclick=()=>{
  showRadius=!showRadius;
  document.getElementById('toggleRadius').innerText=showRadius?'–°–∫—Ä—ã—Ç—å —Ä–∞–¥–∏—É—Å':'–ü–æ–∫–∞–∑–∞—Ç—å —Ä–∞–¥–∏—É—Å';
};
document.getElementById('toggleIndex').onclick=()=>{
  showIndex=!showIndex;
  document.getElementById('enemyIndex').style.display=showIndex?'block':'none';
};

// –ù–∞—á–∞—Ç—å –≤–æ–ª–Ω—É
function startWave() {
  stats.wave++;
  document.getElementById('statsWave').innerText=stats.wave;
  // –Ω–∞–≥—Ä–∞–¥—ã
  stats.diamonds+=1;
  if (difficulty==='hard') stats.diamonds+=2;
  if (difficulty==='extreme') stats.diamonds+=3;

  waveCounter++;
  if (waveCounter>=waveRewardCount) {
    stats.diamonds+=waveCounter*2;
    waveCounter=0;
  }
  updateStats();

  if (stats.wave%5===0) waveMultiplier*=2;
  enemiesToSpawn=5+Math.floor(stats.wave/2);
  enemySpawnTimer=0;
}

// –ö–Ω–æ–ø–∫–∏ –ø–æ–∫—É–ø–æ–∫
document.getElementById('openNormalCase').onclick=()=> {
  if (stats.diamonds>=50) {
    stats.diamonds-=50;
    updateStats();
    openCase('normal');
  } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤');
};
document.getElementById('openPremiumCase').onclick=()=> {
  if (stats.diamonds>=200) {
    stats.diamonds-=200;
    updateStats();
    openCase('premium');
  } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤');
};
document.getElementById('buyExtreme').onclick=()=> {
  if (stats.diamonds>=25) {
    stats.diamonds-=25;
    updateStats();
    selectDifficulty('extreme');
  } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤');
};
document.getElementById('buyMapMountains').onclick=()=> {
  if (stats.diamonds>=20) {
    stats.diamonds-=20;
    updateStats();
    selectMap('mountains');
    setPath();
  } else alert('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∞–ª–º–∞–∑–æ–≤');
};

// –û—Ç–∫—Ä—ã—Ç–∏–µ –∫–µ–π—Å–∞
function openCase(type='normal') {
  const rand=Math.random()*100;
  let item=null;
  if (type==='normal') {
    if (rand<=45) item='doublepistol';
    else if (rand<=75) item='bomb';
    else if (rand<=95) item='farm';
    else if (rand<=99) item='toxic';
    else if (rand<=99.6) item='turret';
    else item='empty';
  } else {
    if (rand<=40) item='bomb';
    else if (rand<=65) item='farm';
    else if (rand<=85) item='toxic';
    else if (rand<=97.5) item='turret';
    else item='empty';
  }
  // –¥–æ–±–∞–≤–ª—è–µ–º –±–∞—à–Ω—é
  switch(item) {
    case 'doublepistol':
      towers.push(new Tower(150,150,'doublepistol'));
      break;
    case 'bomb':
      towers.push(new Tower(200,200,'bomb'));
      break;
    case 'farm':
      towers.push(new Tower(250,250,'farm'));
      break;
    case 'toxic':
      towers.push(new Tower(300,300,'toxic'));
      break;
    case 'turret':
      towers.push(new Tower(350,350,'turret'));
      break;
    case 'empty':
      towers.push(new Tower(400,400,'empty'));
      break;
  }
}

// –°—Ç–∞—Ä—Ç–æ–≤–∞—è –≤–æ–ª–Ω–∞
startWave();

// –ó–∞–ø—É—Å–∫ —Ü–∏–∫–ª–∞
gameLoop();

</script>
</body>
</html>
